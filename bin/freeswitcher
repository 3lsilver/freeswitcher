#!/usr/bin/env ruby

require 'rubygems'
require 'eventmachine'
require 'lib/event'
require 'pp'

module FreeSwitcher

  module Client
    def post_init
      say('auth ClueCon')
      say('event plain ALL')
    end

    def receive_data(data)
      Server.broadcast(data)
      pp event = Event.from(data)
    end

    def say(line)
      send_data("#{line}\n\n")
    end
  end

  module Server
    CLIENTS = []

    def self.broadcast(data)
      CLIENTS.each{|client| client.send_data(data) }
    end

    def post_init
      CLIENTS << self
    end

    def unbind
      CLIENTS.delete(self)
    end
  end
end

EM.run do
  EventMachine::connect("localhost", 8021, FreeSwitcher::Client)
  EventMachine::start_server("localhost", 9000, FreeSwitcher::Server)
end
